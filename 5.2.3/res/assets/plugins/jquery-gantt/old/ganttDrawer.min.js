function Ganttalendar(c,d,e,b,a){this.master=b;this.element;this.highlightBar;this.zoom=c;this.minGanttSize=a;this.includeToday=true;this.showCriticalPath=false;this.zoomLevels=["d","w","m","q","s","y"];this.element=this.create(c,d,e)}Ganttalendar.prototype.zoomGantt=function(b){var a=this.zoom;var d=this.zoomLevels.indexOf(a+"");var c=d;if(b){c=d<=0?0:d-1}else{c=d>=this.zoomLevels.length-1?this.zoomLevels.length-1:d+1}if(c!=d){a=this.zoomLevels[c];this.zoom=a;this.refreshGantt()}};Ganttalendar.prototype.create=function(j,e,f){var k=this;function c(o,m,n){var p=new Date(m);var l=new Date(n);if(o=="d"){p.setHours(0,0,0,0);l.setHours(23,59,59,999);p.setFirstDayOfThisWeek();l.setFirstDayOfThisWeek();l.setDate(l.getDate()+6)}else{if(o=="w"){p.setHours(0,0,0,0);l.setHours(23,59,59,999);p.setFirstDayOfThisWeek();l.setFirstDayOfThisWeek();l.setDate(l.getDate()+6)}else{if(o=="m"){p.setHours(0,0,0,0);l.setHours(23,59,59,999);p.setDate(1);l.setDate(1);l.setMonth(l.getMonth()+1);l.setDate(l.getDate()-1)}else{if(o=="q"){p.setHours(0,0,0,0);l.setHours(23,59,59,999);p.setDate(1);p.setMonth(Math.floor(p.getMonth()/3)*3);l.setDate(1);l.setMonth(Math.floor(l.getMonth()/3)*3+3);l.setDate(l.getDate()-1)}else{if(o=="s"){p.setHours(0,0,0,0);l.setHours(23,59,59,999);p.setDate(1);p.setMonth(Math.floor(p.getMonth()/6)*6);l.setDate(1);l.setMonth(Math.floor(l.getMonth()/6)*6+6);l.setDate(l.getDate()-1)}else{if(o=="y"){p.setHours(0,0,0,0);l.setHours(23,59,59,999);p.setDate(1);p.setMonth(0);l.setDate(1);l.setMonth(12);l.setDate(l.getDate()-1)}}}}}}return{start:p.getTime(),end:l.getTime()}}function d(p,n,l,m){var o=$("<th>").html(p).attr("colSpan",n);if(m){o.width(m)}if(l){o.addClass(l)}return o}function a(n,o,l){var m=$("<td>").html("").attr("colSpan",n).addClass("ganttBodyCell");if(o){m.addClass("end")}if(l){m.addClass(l)}return m}function b(y,z,A){var o=$("<tr>").addClass("ganttHead1");var n=$("<tr>").addClass("ganttHead2");var q=$("<tr>").addClass("ganttBody");function m(x,C){var B=new Date(z);while(B.getTime()<=A){x(B)}B=new Date(z);while(B.getTime()<=A){C(B)}}var l;if(y=="y"){l=Math.floor(((A-z)/(3600000*24*180))*100);m(function(x){o.append(d(x.format("yyyy"),2));x.setFullYear(x.getFullYear()+1)},function(x){var B=(Math.floor(x.getMonth()/6)+1);n.append(d(GanttMaster.messages.GANTT_SEMESTER_SHORT+B,1,null,100));q.append(a(1,B==2));x.setMonth(x.getMonth()+6)})}else{if(y=="s"){l=Math.floor(((A-z)/(3600000*24*90))*100);m(function(B){var x=new Date(B.getTime());x.setMonth(x.getMonth()+6);x.setDate(x.getDate()-1);o.append(d(B.format("MMM")+" - "+x.format("MMM yyyy"),2));B.setMonth(B.getMonth()+6)},function(B){var x=(Math.floor(B.getMonth()/3)+1);n.append(d(GanttMaster.messages.GANTT_QUARTER_SHORT+x,1,null,100));q.append(a(1,x%2==0));B.setMonth(B.getMonth()+3)})}else{if(y=="q"){l=Math.floor(((A-z)/(3600000*24*30))*300);m(function(B){var x=new Date(B.getTime());x.setMonth(x.getMonth()+3);x.setDate(x.getDate()-1);o.append(d(B.format("MMM")+" - "+x.format("MMM yyyy"),3));B.setMonth(B.getMonth()+3)},function(x){var B=x.format("MMM");n.append(d(B,1,null,300));q.append(a(1,x.getMonth()%3==2));x.setMonth(x.getMonth()+1)})}else{if(y=="m"){l=Math.floor(((A-z)/(3600000*24*1))*25);m(function(B){var C=B.getTime();B.setMonth(B.getMonth()+1);var x=Math.round((B.getTime()-C)/(3600000*24));o.append(d(new Date(C).format("MMMM yyyy"),x))},function(x){n.append(d(x.format("d"),1,isHoliday(x)?"holyH":null,25));var B=new Date(x.getTime());B.setDate(x.getDate()+1);q.append(a(1,B.getDate()==1,isHoliday(x)?"holy":null));x.setDate(x.getDate()+1)})}else{if(y=="w"){l=Math.floor(((A-z)/(3600000*24))*40);m(function(B){var x=new Date(B.getTime());x.setDate(x.getDate()+6);o.append(d(B.format("MMM d")+" - "+x.format("MMM d'yy"),7));B.setDate(B.getDate()+7)},function(x){n.append(d(x.format("EEEE").substr(0,1),1,isHoliday(x)?"holyH":null,40));q.append(a(1,x.getDay()%7==(k.master.firstDayOfWeek+6)%7,isHoliday(x)?"holy":null));x.setDate(x.getDate()+1)})}else{if(y=="d"){l=Math.floor(((A-z)/(3600000*24))*100);m(function(B){var x=new Date(B.getTime());x.setDate(x.getDate()+6);o.append(d(B.format("MMMM d")+" - "+x.format("MMMM d yyyy"),7));B.setDate(B.getDate()+7)},function(x){n.append(d(x.format("EEE d"),1,isHoliday(x)?"holyH":null,100));q.append(a(1,x.getDay()%7==(k.master.firstDayOfWeek+6)%7,isHoliday(x)?"holy":null));x.setDate(x.getDate()+1)})}else{console.error("Wrong level "+y)}}}}}}l=Math.max(l,k.minGanttSize);var w=$("<table cellspacing=0 cellpadding=0>");w.append(o).append(n).css({width:l});var s=w.clone().addClass("fixHead");w.append(q).addClass("ganttTable");w.height(k.master.editor.element.height());var p=$("<div>");p.addClass("gantt unselectable").attr("unselectable","true").css({position:"relative",width:l});p.append(w);p.append(s);var u=$("<div>").addClass("ganttHighLight");p.append(u);k.highlightBar=u;var v=$("<div>");v.addClass("ganttLinks").css({position:"absolute",top:0,width:l,height:"100%"});p.append(v);k.fx=l/(A-z);if(new Date().getTime()>k.startMillis&&new Date().getTime()<k.endMillis){var t=Math.round(((new Date().getTime())-k.startMillis)*k.fx);var r=$("<div>").addClass("ganttToday").css("left",t);p.append(r)}return p}if(this.includeToday){var h=new Date().getTime();e=e>h?h:e;f=f<h?h:f}var g=c(j,e,f);k.startMillis=g.start;k.endMillis=g.end;k.originalStartMillis=e;k.originalEndMillis=f;var i=b(j,g.start,g.end);return i};Ganttalendar.prototype.drawTask=function(d){var c=this;editorRow=d.rowElement;var e=editorRow.position().top+editorRow.offsetParent().scrollTop();var a=Math.round((d.start-c.startMillis)*c.fx);var f=$.JST.createFromTemplate(d,"TASKBAR");d.ganttElement=f;if(d.isParent()){f.addClass("hasChild")}f.css({top:e,left:a,width:Math.round((d.end-d.start)*c.fx)});if(this.master.canWrite&&d.canWrite){f.resizable({handles:"e"+(d.depends?"":",w"),resize:function(g,h){$(".taskLabel[taskId="+h.helper.attr("taskId")+"]").css("width",h.position.left);g.stopImmediatePropagation();g.stopPropagation()},stop:function(i,j){var g=c.master.getTask(j.element.attr("taskId"));var h=Math.round((j.position.left/c.fx)+c.startMillis);var k=Math.round(((j.position.left+j.size.width)/c.fx)+c.startMillis);c.master.beginTransaction();c.master.changeTaskDates(g,new Date(h),new Date(k));c.master.endTransaction()}}).on("mouseup",function(){$(":focus").blur()})}f.dblclick(function(){c.master.showTaskEditor($(this).closest("[taskId]").attr("taskId"))}).mousedown(function(){var g=c.master.getTask($(this).attr("taskId"));g.rowElement.click()});if(!d.depends&&this.master.canWrite&&d.canWrite){f.css("position","absolute").draggable({axis:"x",drag:function(g,h){$(".taskLabel[taskId="+$(this).attr("taskId")+"]").css("width",h.position.left)},stop:function(i,j){var g=c.master.getTask($(this).attr("taskId"));var h=Math.round((j.position.left/c.fx)+c.startMillis);c.master.beginTransaction();c.master.moveTask(g,new Date(h));c.master.endTransaction()}})}var b=$("<div class='ganttLines'></div>");b.css({top:e+b.height()});c.element.append(f);c.element.append(b);c.redrawLinks()};Ganttalendar.prototype.addTask=function(a){this.originalEndMillis=this.originalEndMillis>a.end?this.originalEndMillis:a.end;this.originalStartMillis=this.originalStartMillis<a.start?this.originalStartMillis:a.start};Ganttalendar.prototype.drawLink=function(g,h,d){var b=10;var i=2;HLine=function(l,n,m){var k=$("<div>").addClass("taskDepLine");k.css({height:i,left:m,width:l,top:n-i/2});return k};VLine=function(k,n,m){var l=$("<div>").addClass("taskDepLine");l.css({height:k,left:m-i/2,width:i,top:n});return l};function j(l){var k=l.ganttElement.position();k.width=l.ganttElement.width();k.height=l.ganttElement.height();return k}function f(l,o,p){var m,r;var q=$("<div>").attr({from:g.id,to:h.id});var z=l.left+l.width;var x=l.height/2+l.top;var A=(z+2*p)<o.left;if(!A){if(p>0){var y=new HLine(p,x,z);z=z+p;q.append(y)}var C=((o.top+o.height/2)-(l.top+l.height/2))/2;var w;if(C<0){w=new VLine(-C,x+C,z)}else{w=new VLine(C,x,z)}x=x+C;q.append(w);var n=l.left+l.width+p-(o.left-p);z=z-n;var v=new HLine(n,x,z);q.append(v);var u;if(C<0){u=new VLine(-C,x+C,z)}else{u=new VLine(C,x,z)}q.append(u);x=x+C;if(p>0){var t=new HLine(p,x,z);z=z+p;q.append(t)}}else{var s=(o.left-z)/2;var y=new HLine(s,x,z);z=z+s;q.append(y);var B=((o.top+o.height/2)-(l.top+l.height/2));var w;if(B<0){w=new VLine(-B,x+B,z)}else{w=new VLine(B,x,z)}q.append(w);x=x+B;var v=new HLine(s,x,z);z=z+s;q.append(v)}var k=$("<img src='res/linkArrow.png'>").css({position:"absolute",top:o.top+o.height/2-5,left:o.left-5});q.append(k);return q}function a(l,o,p){var m,r;var q=$("<div>").attr({from:g.id,to:h.id});var y=l.left;var w=l.height/2+l.top;var z=(y+2*p)<o.left;if(!z){if(p>0){var x=new HLine(p,w,y-p);y=y-p;q.append(x)}var B=((o.top+o.height/2)-(l.top+l.height/2))/2;var v;if(B<0){v=new VLine(-B,w+B,y)}else{v=new VLine(B,w,y)}w=w+B;q.append(v);var n=(l.left-p)-(o.left-p);y=y-n;var u=new HLine(n,w,y);q.append(u);var t;if(B<0){t=new VLine(-B,w+B,y)}else{t=new VLine(B,w,y)}q.append(t);w=w+B;if(p>0){var s=new HLine(p,w,y);y=y+p;q.append(s)}}else{var x=new HLine(p,w,y-p);y=y-p;q.append(x);var A=((o.top+o.height/2)-(l.top+l.height/2));var v;if(A<0){v=new VLine(-A,w+A,y)}else{v=new VLine(A,w,y)}q.append(v);w=w+A;var u=new HLine(y+p+(o.left-l.left),w,y);y=y+p+(o.left-l.left);q.append(u)}var k=$("<img src='res/linkArrow.png'>").css({position:"absolute",top:o.top+o.height/2-5,left:o.left-5});q.append(k);return q}var e=j(g);var c=j(h);if(d=="start-to-start"){this.element.find(".ganttLinks").append(a(e,c,b))}else{this.element.find(".ganttLinks").append(f(e,c,b))}};Ganttalendar.prototype.redrawLinks=function(){var a=this;this.element.stopTime("ganttlnksredr");this.element.oneTime(60,"ganttlnksredr",function(){a.element.find(".ganttLinks").empty();var b=a.master.getCollapsedDescendant();for(var c=0;c<a.master.links.length;c++){var d=a.master.links[c];if(b.indexOf(d.from)>=0||b.indexOf(d.to)>=0){continue}a.drawLink(d.from,d.to)}})};Ganttalendar.prototype.reset=function(){this.element.find(".ganttLinks").empty();this.element.find("[taskId]").remove()};Ganttalendar.prototype.redrawTasks=function(){var a=this.master.getCollapsedDescendant();for(var c=0;c<this.master.tasks.length;c++){var b=this.master.tasks[c];if(a.indexOf(b)>=0){continue}this.drawTask(b)}};Ganttalendar.prototype.refreshGantt=function(){var b=this.element.parent();var c=b.scrollTop();var d=b.scrollLeft();this.element.remove();if(!this.zoom){var e=Math.round((this.originalEndMillis-this.originalStartMillis)/(3600000*24));this.zoom=this.zoomLevels[e<2?0:(e<15?1:(e<60?2:(e<150?3:4)))]}var a=this.create(this.zoom,this.originalStartMillis,this.originalEndMillis);this.element=a;b.append(a);this.redrawTasks();this.synchHighlight();b.scrollTop(c);b.scrollLeft(d);if(this.showCriticalPath){this.master.computeCriticalPath();this.gantt.showCriticalPath()}};Ganttalendar.prototype.fitGantt=function(){delete this.zoom;this.refreshGantt()};Ganttalendar.prototype.synchHighlight=function(){if(this.master.currentTask&&this.master.currentTask.ganttElement){this.highlightBar.css("top",this.master.currentTask.ganttElement.css("top"))}};Ganttalendar.prototype.centerOnToday=function(){var a=Math.round(((new Date().getTime())-this.startMillis)*this.fx)-30;this.element.parent().scrollLeft(a)};Ganttalendar.prototype.showCriticalPath=function(){console.error("To be implemented")};