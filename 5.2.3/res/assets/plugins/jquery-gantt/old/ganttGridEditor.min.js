function GridEditor(a){this.master=a;this.gridified=$.gridify($.JST.createFromTemplate({},"TASKSEDITHEAD"));this.element=this.gridified.find(".gdfTable").eq(1)}GridEditor.prototype.fillEmptyLines=function(){var a=new TaskFactory();var c=30-this.element.find(".taskEditRow").size();for(var d=0;d<c;d++){var b=$.JST.createFromTemplate({},"TASKEMPTYROW");var e=this.master;b.click(function(h){var g=$(this);if(!e.canWrite||g.prevAll(".emptyRow").size()>0){return}e.beginTransaction();var f;var j=new Date().getTime();var i=0;if(e.tasks[0]){j=e.tasks[0].start;i=e.tasks[0].level+1}g.prevAll(".emptyRow").andSelf().each(function(){var l=a.build("tmp_fk"+new Date().getTime(),"","",i,j,1);var k=e.addTask(l);f=l});e.endTransaction();f.rowElement.click();f.rowElement.find("[name=name]").focus().blur(function(){var k=$(this);if(k.val()==""){f.name="Task "+(f.getRow()+1);k.val(f.name)}})});this.element.append(b)}};GridEditor.prototype.addTask=function(c,g,f){this.element.find("[taskId="+c.id+"]").remove();var b=$.JST.createFromTemplate(c,"TASKROW");c.rowElement=b;this.bindRowEvents(c,b);if(typeof(g)!="number"){var d=this.element.find(".emptyRow:first");if(d.size()>0){d.replaceWith(b)}else{this.element.append(b)}}else{var e=this.element.find("tr.taskEditRow").eq(g);if(e.size()>0){e.before(b)}else{this.element.append(b)}}this.element.find(".taskRowIndex").each(function(h,j){$(j).html(h+1)});if(f){if(c.collapsed){b.find(".exp-controller").removeClass("exp")}var a=this.master.getCollapsedDescendant();if(a.indexOf(c)>=0){b.hide()}}return b};GridEditor.prototype.refreshExpandStatus=function(a){if(!a){return}var c=a.getChildren();if(c.length>0&&a.rowElement.has(".expcoll").length==0){a.rowElement.find(".exp-controller").addClass("expcoll exp")}else{if(c.length==0&&a.rowElement.has(".expcoll").length>0){a.rowElement.find(".exp-controller").removeClass("expcoll exp")}}var b=a.getParent();if(b&&b.rowElement.has(".expcoll").length==0){b.rowElement.find(".exp-controller").addClass("expcoll exp")}};GridEditor.prototype.refreshTaskRow=function(a){var b=a.rowElement;b.find(".taskRowIndex").html(a.getRow()+1);b.find(".indentCell").css("padding-left",a.level*16+12);b.find("[name=name]").val(a.name);b.find("[name=code]").val(a.code);b.find("[status]").attr("status",a.status);b.find("[name=duration]").val(a.duration);b.find("[name=start]").val(new Date(a.start).format()).updateOldValue();b.find("[name=end]").val(new Date(a.end).format()).updateOldValue();b.find("[name=depends]").val(a.depends);b.find(".taskAssigs").html(a.getAssigsString())};GridEditor.prototype.redraw=function(){for(var a=0;a<this.master.tasks.length;a++){this.refreshTaskRow(this.master.tasks[a])}};GridEditor.prototype.reset=function(){this.element.find("[taskId]").remove()};GridEditor.prototype.bindRowEvents=function(c,b){var a=this;if(this.master.canWrite&&c.canWrite){a.bindRowInputEvents(c,b)}else{b.find("input").attr("readonly",true)}a.bindRowExpandEvents(c,b);b.find(".edit").click(function(){a.openFullEditor(c,b)})};GridEditor.prototype.bindRowExpandEvents=function(c,b){var a=this;b.find(".exp-controller").click(function(){var j=$(this);var h=j.closest("[taskId]").attr("taskId");var f=a.master.getTask(h);var k=f.getDescendant();j.toggleClass("exp");f.collapsed=!j.is(".exp");var e=a.master.getCollapsedDescendant();if(j.is(".exp")){for(var g=0;g<k.length;g++){var d=k[g];if(e.indexOf(d)>=0){continue}d.rowElement.show()}}else{for(var g=0;g<k.length;g++){k[g].rowElement.hide()}}a.master.gantt.refreshGantt()})};GridEditor.prototype.bindRowInputEvents=function(c,b){var a=this;b.find(".date").each(function(){var d=$(this);if(c.depends&&d.attr("name")=="start"){d.attr("readonly","true")}else{d.removeAttr("readonly")}d.click(function(){var e=$(this);e.dateField({inputField:d})});d.blur(function(h){var j=$(this);if(j.isValueChanged()){if(!Date.isValid(j.val())){alert(GanttMaster.messages.INVALID_DATE_FORMAT);j.val(j.getOldValue())}else{var h=Date.parseString(j.val());var l=j.closest("tr");var i=l.attr("taskId");var f=a.master.getTask(i);var g=f.start;var k=f.end;if(j.attr("name")=="start"){g=h.getTime();if(g>=k){var e=new Date(g);k=e.add("d",f.duration).getTime()}a.master.beginTransaction();a.master.moveTask(f,g);a.master.endTransaction()}else{k=h.getTime();if(g>=k){k=g}k=k+3600000*20;a.master.beginTransaction();a.master.changeTaskDates(f,g,k);a.master.endTransaction()}j.updateOldValue()}}})});b.find("input:not(.date)").focus(function(){$(this).updateOldValue()}).blur(function(){var e=$(this);if(e.isValueChanged()){var o=e.closest("tr");var k=o.attr("taskId");var f=a.master.getTask(k);var l=e.attr("name");a.master.beginTransaction();if(l=="depends"){var n=f.depends;f.depends=e.val();if(f.depends){o.find("[name=start]").attr("readonly","true")}else{o.find("[name=start]").removeAttr("readonly")}var m=a.master.updateLinks(f);if(m){var j=f.getSuperiors();for(var h=0;h<j.length;h++){if(!j[h].from.synchronizeStatus()){break}}a.master.changeTaskDates(f,f.start,f.end)}}else{if(l=="duration"){var d=f.duration;d=parseInt(e.val())||1;e.val(d);var g=computeEndByDuration(f.start,d);a.master.changeTaskDates(f,f.start,g)}else{if(l=="name"&&e.val()==""){f.deleteTask()}else{f[l]=e.val()}}}a.master.endTransaction()}});b.find("input").keydown(function(d){var j=$(this);var f=j.parent();var g=f.parent();var h=f.prevAll("td").size();var k=true;switch(d.keyCode){case 37:if(this.selectionEnd==0){f.prev().find("input").focus()}break;case 39:if(this.selectionEnd==this.value.length){f.next().find("input").focus()}break;case 38:var e=g.prev();var i=e.find("td").eq(h);var l=i.find("input");if(l.size()>0){l.focus()}break;case 40:var m=g.next();var i=m.find("td").eq(h);var l=i.find("input");if(l.size()>0){l.focus()}else{m.click()}break;case 36:break;case 35:break;case 9:case 13:break}return k}).focus(function(){$(this).closest("tr").click()});b.find(".taskStatus").click(function(){var f=$(this);var h=f.closest("[taskId]");var e=h.attr("taskId");var d=a.master.getTask(e);var g=$.JST.createFromTemplate({},"CHANGE_STATUS");g.find("[status="+d.status+"]").addClass("selected");g.find(".taskStatus").click(function(j){j.stopPropagation();var i=$(this).attr("status");g.remove();a.master.beginTransaction();d.changeStatus(i);a.master.endTransaction();f.attr("status",d.status)});f.oneTime(3000,"hideChanger",function(){g.remove()});f.append(g)});b.click(function(){var e=$(this);e.closest("table").find(".rowSelected").removeClass("rowSelected");e.addClass("rowSelected");a.master.currentTask=a.master.getTask(e.attr("taskId"));a.master.gantt.synchHighlight();var d=e.position().top;if(d>a.element.parent().height()){e.offsetParent().scrollTop(d-a.element.parent().height()+100)}else{if(d<40){e.offsetParent().scrollTop(e.offsetParent().scrollTop()-40+d)}}})};GridEditor.prototype.openFullEditor=function(b,m){var n=this;var j=m.attr("taskId");var l=$.JST.createFromTemplate({},"TASK_EDITOR");l.find("#name").val(b.name);l.find("#description").val(b.description);l.find("#code").val(b.code);l.find("#progress").val(b.progress?parseFloat(b.progress):0);l.find("#status").attr("status",b.status);if(b.startIsMilestone){l.find("#startIsMilestone").attr("checked",true)}if(b.endIsMilestone){l.find("#endIsMilestone").attr("checked",true)}l.find("#duration").val(b.duration);var c=l.find("#start");c.val(new Date(b.start).format());if(b.depends){c.attr("readonly","true")}else{c.removeAttr("readonly")}l.find("#end").val(new Date(b.end).format());var h=l.find("#assigsTable");h.find("[assigId]").remove();for(var f=0;f<b.assigs.length;f++){var g=b.assigs[f];var d=$.JST.createFromTemplate({task:b,assig:g},"ASSIGNMENT_ROW");h.append(d)}function a(i){var o=parseInt(l.find("#duration").val());i.clearTime();l.find("#end").val(new Date(computeEndByDuration(i.getTime(),o)).format())}function k(i){var p=Date.parseString(l.find("#start").val());i.setHours(23,59,59,999);if(i.getTime()<p.getTime()){var o=parseInt(l.find("#duration").val());p=incrementDateByWorkingDays(i.getTime(),-o);l.find("#start").val(new Date(computeStart(p)).format())}else{l.find("#duration").val(recomputeDuration(p.getTime(),i.getTime()))}}if(!n.master.canWrite||!b.canWrite){l.find("input,textarea").attr("readOnly",true);l.find("input:checkbox,select").attr("disabled",true)}else{l.find("#start").click(function(){$(this).dateField({inputField:$(this),callback:a})}).blur(function(){var i=$(this);if(!Date.isValid(i.val())){alert(GanttMaster.messages.INVALID_DATE_FORMAT);i.val(i.getOldValue())}else{a(Date.parseString(i.val()))}});l.find("#end").click(function(){$(this).dateField({inputField:$(this),callback:k})}).blur(function(){var i=$(this);if(!Date.isValid(i.val())){alert(GanttMaster.messages.INVALID_DATE_FORMAT);i.val(i.getOldValue())}else{k(Date.parseString(i.val()))}});l.find("#duration").change(function(){var p=Date.parseString(l.find("#start").val());var o=$(this);var i=parseInt(o.val());i=i<=0?1:i;o.val(i);l.find("#end").val(new Date(computeEndByDuration(p.getTime(),i)).format())});l.find("#addAssig").click(function(){var i=l.find("#assigsTable");var o=$.JST.createFromTemplate({task:b,assig:{id:"tmp_"+new Date().getTime()}},"ASSIGNMENT_ROW");i.append(o)});l.find("#status").click(function(){var i=$(this);var o=$.JST.createFromTemplate({},"CHANGE_STATUS");o.find("[status="+b.status+"]").addClass("selected");o.find(".taskStatus").click(function(p){p.stopPropagation();i.attr("status",$(this).attr("status"));o.remove()});i.oneTime(3000,"hideChanger",function(){o.remove()});i.append(o)});l.find("#saveButton").click(function(){var i=n.master.getTask(j);n.master.beginTransaction();i.name=l.find("#name").val();i.description=l.find("#description").val();i.code=l.find("#code").val();i.progress=parseFloat(l.find("#progress").val());i.duration=parseInt(l.find("#duration").val());i.startIsMilestone=l.find("#startIsMilestone").is(":checked");i.endIsMilestone=l.find("#endIsMilestone").is(":checked");l.find("tr[assigId]").each(function(){var v=$(this);var t=v.attr("assigId");var u=v.find("[name=resourceId]").val();var p=v.find("[name=roleId]").val();var r=millisFromString(v.find("[name=effort]").val());var s=false;for(var q=0;q<i.assigs.length;q++){var o=i.assigs[q];if(t==o.id){o.effort=r;o.roleId=p;o.resourceId=u;o.touched=true;s=true;break}else{if(p==o.roleId&&u==o.resourceId){o.effort=r;o.touched=true;s=true;break}}}if(!s){var o=i.createAssignment("tmp_"+new Date().getTime(),u,p,r);o.touched=true}});i.assigs=i.assigs.filter(function(o){var p=o.touched;delete o.touched;return p});i.setPeriod(Date.parseString(l.find("#start").val()).getTime(),Date.parseString(l.find("#end").val()).getTime()+(3600000*24));i.changeStatus(l.find("#status").attr("status"));if(n.master.endTransaction()){$("#__blackpopup__").trigger("close")}})}var e=createBlackPage(800,500).append(l)};