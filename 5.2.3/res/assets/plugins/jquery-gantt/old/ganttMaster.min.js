function GanttMaster(){this.tasks=[];this.deletedTaskIds=[];this.links=[];this.editor;this.gantt;this.element;this.resources;this.roles;this.minEditableDate=0;this.maxEditableDate=Infinity;this.canWriteOnParent=true;this.canWrite=true;this.firstDayOfWeek=Date.firstDayOfWeek;this.currentTask;this.__currentTransaction;this.__undoStack=[];this.__redoStack=[];this.__inUndoRedo=false;var a=this}GanttMaster.prototype.init=function(a){this.element=a;var b=this;$("#gantEditorTemplates").loadTemplates().remove();this.editor=new GridEditor(this);a.append(this.editor.gridified);this.gantt=new Ganttalendar("m",new Date().getTime()-3600000*24*2,new Date().getTime()+3600000*24*15,this,a.width()*0.6);var c=$.splittify.init(a,this.editor.gridified,this.gantt.element,60);b.splitter=c;a.before($.JST.createFromTemplate({},"GANTBUTTONS"));a.bind("refreshTasks.gantt",function(){b.redrawTasks()}).bind("refreshTask.gantt",function(f,d){b.drawTask(d)}).bind("deleteCurrentTask.gantt",function(d){b.deleteCurrentTask()}).bind("addAboveCurrentTask.gantt",function(){b.addAboveCurrentTask()}).bind("addBelowCurrentTask.gantt",function(){b.addBelowCurrentTask()}).bind("indentCurrentTask.gantt",function(){b.indentCurrentTask()}).bind("outdentCurrentTask.gantt",function(){b.outdentCurrentTask()}).bind("moveUpCurrentTask.gantt",function(){b.moveUpCurrentTask()}).bind("moveDownCurrentTask.gantt",function(){b.moveDownCurrentTask()}).bind("zoomPlus.gantt",function(){b.gantt.zoomGantt(true)}).bind("zoomMinus.gantt",function(){b.gantt.zoomGantt(false)}).bind("undo.gantt",function(){if(!b.canWrite){return}b.undo()}).bind("redo.gantt",function(){if(!b.canWrite){return}b.redo()}).bind("resize.gantt",function(){b.resize()});$("body").bind("keydown.body",function(g){if(g.target.nodeName.toLowerCase()=="body"||g.target.nodeName.toLowerCase()=="svg"){var d=true;switch(g.keyCode){case 46:case 8:var f=b.gantt.element.find(".focused.focused");if(f.is(".taskBox")){b.deleteCurrentTask()}else{if(f.is(".linkGroup")){b.removeLink(f.data("from"),f.data("to"))}}break;case 38:if(b.currentTask){if(b.currentTask.ganttElement.is(".focused")){b.moveUpCurrentTask();b.gantt.element.oneTime(100,function(){b.currentTask.ganttElement.addClass("focused")})}else{b.currentTask.rowElement.prev().click()}}break;case 40:if(b.currentTask){if(b.currentTask.ganttElement.is(".focused")){b.moveDownCurrentTask();b.gantt.element.oneTime(100,function(){b.currentTask.ganttElement.addClass("focused")})}else{b.currentTask.rowElement.next().click()}}break;case 39:if(b.currentTask){if(b.currentTask.ganttElement.is(".focused")){b.indentCurrentTask();b.gantt.element.oneTime(100,function(){b.currentTask.ganttElement.addClass("focused")})}}break;case 37:if(b.currentTask){if(b.currentTask.ganttElement.is(".focused")){b.outdentCurrentTask();b.gantt.element.oneTime(100,function(){b.currentTask.ganttElement.addClass("focused")})}}break;case 89:if(g.ctrlKey){b.redo()}break;case 90:if(g.ctrlKey){b.undo()}break;default:d=false}if(d){g.preventDefault();g.stopPropagation()}}})};GanttMaster.messages={CANNOT_WRITE:"CANNOT_WRITE",CHANGE_OUT_OF_SCOPE:"NO_RIGHTS_FOR_UPDATE_PARENTS_OUT_OF_EDITOR_SCOPE",START_IS_MILESTONE:"START_IS_MILESTONE",END_IS_MILESTONE:"END_IS_MILESTONE",TASK_HAS_CONSTRAINTS:"TASK_HAS_CONSTRAINTS",GANTT_ERROR_DEPENDS_ON_OPEN_TASK:"GANTT_ERROR_DEPENDS_ON_OPEN_TASK",GANTT_ERROR_DESCENDANT_OF_CLOSED_TASK:"GANTT_ERROR_DESCENDANT_OF_CLOSED_TASK",TASK_HAS_EXTERNAL_DEPS:"TASK_HAS_EXTERNAL_DEPS",GANTT_ERROR_LOADING_DATA_TASK_REMOVED:"GANTT_ERROR_LOADING_DATA_TASK_REMOVED",CIRCULAR_REFERENCE:"CIRCULAR_REFERENCE",ERROR_SETTING_DATES:"ERROR_SETTING_DATES",CANNOT_DEPENDS_ON_ANCESTORS:"CANNOT_DEPENDS_ON_ANCESTORS",CANNOT_DEPENDS_ON_DESCENDANTS:"CANNOT_DEPENDS_ON_DESCENDANTS",INVALID_DATE_FORMAT:"INVALID_DATE_FORMAT",GANTT_QUARTER_SHORT:"GANTT_QUARTER_SHORT",GANTT_SEMESTER_SHORT:"GANTT_SEMESTER_SHORT",CANNOT_CLOSE_TASK_IF_OPEN_ISSUE:"CANNOT_CLOSE_TASK_IF_OPEN_ISSUE"};GanttMaster.prototype.createTask=function(g,b,c,f,e,d){var a=new TaskFactory();return a.build(g,b,c,f,e,d)};GanttMaster.prototype.createResource=function(c,a){var b=new Resource(c,a);return b};GanttMaster.prototype.updateDependsStrings=function(){for(var a=0;a<this.tasks.length;a++){this.tasks[a].depends=""}for(var a=0;a<this.links.length;a++){var b=this.links[a];var c=b.to.depends;b.to.depends=b.to.depends+(b.to.depends==""?"":",")+(b.from.getRow()+1)+(b.lag?":"+b.lag:"")}};GanttMaster.prototype.removeLink=function(b,a){this.beginTransaction();var d=false;for(var c=0;c<this.links.length;c++){if(this.links[c].from==b&&this.links[c].to==a){this.links.splice(c,1);d=true;break}}if(d){this.updateDependsStrings();if(this.updateLinks(a)){this.changeTaskDates(a,a.start,a.end)}}this.endTransaction()};GanttMaster.prototype.addTask=function(b,e){b.master=this;var f=-1;for(var d=0;d<this.tasks.length;d++){if(b.id==this.tasks[d].id){f=d;break}}if(f>=0){this.tasks.splice(f,1);e=parseInt(f)}if(typeof(e)!="number"){this.tasks.push(b)}else{this.tasks.splice(e,0,b);this.updateDependsStrings()}var a=!this.updateLinks(b);if(b.getParent()){b.status=b.getParent().status}else{b.status="STATUS_ACTIVE"}var c=b;if(a||!b.setPeriod(b.start,b.end)){this.tasks.splice(b.getRow(),1);c=undefined}else{this.editor.addTask(b,e);this.gantt.addTask(b)}return c};GanttMaster.prototype.loadProject=function(b){this.beginTransaction();this.resources=b.resources;this.roles=b.roles;this.canWrite=b.canWrite;this.canWriteOnParent=b.canWriteOnParent;this.cannotCloseTaskIfIssueOpen=b.cannotCloseTaskIfIssueOpen;if(b.minEditableDate){this.minEditableDate=computeStart(b.minEditableDate)}else{this.minEditableDate=-Infinity}if(b.maxEditableDate){this.maxEditableDate=computeEnd(b.maxEditableDate)}else{this.maxEditableDate=Infinity}this.loadTasks(b.tasks,b.selectedRow);this.deletedTaskIds=[];this.gantt.refreshGantt();this.endTransaction();var a=this;this.gantt.element.oneTime(200,function(){a.gantt.centerOnToday()})};GanttMaster.prototype.loadTasks=function(h,g){var c=new TaskFactory();this.reset();for(var f=0;f<h.length;f++){var b=h[f];if(!(b instanceof Task)){var e=c.build(b.id,b.name,b.code,b.level,b.start,b.duration,b.collapsed);for(var d in b){if(d!="end"&&d!="start"){e[d]=b[d]}}b=e}b.master=this;this.tasks.push(b)}for(var f=0;f<this.tasks.length;f++){var b=this.tasks[f];var a=!this.updateLinks(b);if(a||!b.setPeriod(b.start,b.end)){alert(GanttMaster.messages.GANNT_ERROR_LOADING_DATA_TASK_REMOVED+"\n"+b.name+"\n"+(a?GanttMaster.messages.CIRCULAR_REFERENCE:GanttMaster.messages.ERROR_SETTING_DATES));this.tasks.splice(b.getRow(),1)}else{this.editor.addTask(b,null,true);this.gantt.addTask(b)}}this.editor.fillEmptyLines();if(this.tasks&&this.tasks.length>0){g=g?g:0;this.tasks[g].rowElement.click()}};GanttMaster.prototype.getTask=function(c){var a;for(var b=0;b<this.tasks.length;b++){var d=this.tasks[b];if(d.id==c){a=d;break}}return a};GanttMaster.prototype.getResource=function(d){var a;for(var c=0;c<this.resources.length;c++){var b=this.resources[c];if(b.id==d){a=b;break}}return a};GanttMaster.prototype.changeTaskDates=function(b,c,a){return b.setPeriod(c,a)};GanttMaster.prototype.moveTask=function(b,a){return b.moveTo(a,true)};GanttMaster.prototype.taskIsChanged=function(){var a=this;this.element.stopTime("gnnttaskIsChanged");this.element.oneTime(50,"gnnttaskIsChanged",function(){a.editor.redraw();a.gantt.refreshGantt()})};GanttMaster.prototype.redraw=function(){this.editor.redraw();this.gantt.refreshGantt()};GanttMaster.prototype.reset=function(){this.tasks=[];this.links=[];this.deletedTaskIds=[];if(!this.__inUndoRedo){this.__undoStack=[];this.__redoStack=[]}else{this.__inUndoRedo=false}delete this.currentTask;this.editor.reset();this.gantt.reset()};GanttMaster.prototype.showTaskEditor=function(b){var a=this.getTask(b);a.rowElement.find(".edit").click()};GanttMaster.prototype.saveProject=function(){return this.saveGantt(false)};GanttMaster.prototype.saveGantt=function(e){var f=[];for(var d=0;d<this.tasks.length;d++){var b=this.tasks[d];var a=b.clone();delete a.master;delete a.rowElement;delete a.ganttElement;f.push(a)}var c={tasks:f};if(this.currentTask){c.selectedRow=this.currentTask.getRow()}c.deletedTaskIds=this.deletedTaskIds;if(!e){c.resources=this.resources;c.roles=this.roles;c.canWrite=this.canWrite;c.canWriteOnParent=this.canWriteOnParent}return c};GanttMaster.prototype.updateLinks=function(b){function a(o,v,w){if(v==o){return true}var t=o.getSuperiors();var j=o.getParent();while(j){t=t.concat(j.getSuperiors());j=j.getParent()}var q=o.getChildren();for(var s=0;s<q.length;s++){t=t.concat(q[s].getSuperiors())}var u=false;for(var s=0;s<t.length;s++){var x=t[s];if(x.from==v){u=true;break}else{if(w.indexOf(x.from.id+"x"+v.id)<=0){w.push(x.from.id+"x"+v.id);if(a(x.from,v,w)){u=true;break}}}}var r=v.getParent();if(r){if(w.indexOf(o.id+"x"+r.id)<=0){w.push(o.id+"x"+r.id);if(a(o,r,w)){u=true}}}return u}this.links=this.links.filter(function(j){return j.to!=b});var m=true;if(b.depends){var l=b.getParents();var d=b.getDescendant();var n=b.depends.split(",");var g="";var i=[];for(var e=0;e<n.length;e++){var k=n[e];var h=k.split(":");var c=0;if(h.length>1){c=parseInt(h[1])}var f=this.tasks[parseInt(h[0]-1)];if(f){if(l&&l.indexOf(f)>=0){this.setErrorOnTransaction(b.name+"\n"+GanttMaster.messages.CANNOT_DEPENDS_ON_ANCESTORS+"\n"+f.name);m=false}else{if(d&&d.indexOf(f)>=0){this.setErrorOnTransaction(b.name+"\n"+GanttMaster.messages.CANNOT_DEPENDS_ON_DESCENDANTS+"\n"+f.name);m=false}else{if(a(f,b,i)){m=false;this.setErrorOnTransaction(GanttMaster.messages.CIRCULAR_REFERENCE+"\n"+b.name+" -> "+f.name)}else{this.links.push(new Link(f,b,c));g=g+(g.length>0?",":"")+k}}}}}if(m){b.depends=g}}return m};GanttMaster.prototype.moveUpCurrentTask=function(){var a=this;if(!a.canWrite){return}if(a.currentTask){a.beginTransaction();a.currentTask.moveUp();a.endTransaction()}};GanttMaster.prototype.moveDownCurrentTask=function(){var a=this;if(!a.canWrite){return}if(a.currentTask){a.beginTransaction();a.currentTask.moveDown();a.endTransaction()}};GanttMaster.prototype.outdentCurrentTask=function(){var a=this;if(!a.canWrite||!a.currentTask.canWrite){return}if(a.currentTask){var b=a.currentTask.getParent();a.beginTransaction();a.currentTask.outdent();a.endTransaction();if(b){a.editor.refreshExpandStatus(b)}}};GanttMaster.prototype.indentCurrentTask=function(){var a=this;if(!a.canWrite||!a.currentTask.canWrite){return}if(a.currentTask){a.beginTransaction();a.currentTask.indent();a.endTransaction()}};GanttMaster.prototype.addBelowCurrentTask=function(){var c=this;if(!c.canWrite){return}var b=new TaskFactory();c.beginTransaction();var d;var e=0;if(c.currentTask){d=b.build("tmp_"+new Date().getTime(),"","",c.currentTask.level+1,c.currentTask.start,1);e=c.currentTask.getRow()+1}else{d=b.build("tmp_"+new Date().getTime(),"","",0,new Date().getTime(),1)}var a=c.addTask(d,e);if(a){a.rowElement.click();a.rowElement.find("[name=name]").focus()}c.endTransaction()};GanttMaster.prototype.addAboveCurrentTask=function(){var c=this;if(!c.canWrite){return}var b=new TaskFactory();var d;var e=0;if(c.currentTask){if(c.currentTask.level<=0){return}d=b.build("tmp_"+new Date().getTime(),"","",c.currentTask.level,c.currentTask.start,1);e=c.currentTask.getRow()}else{d=b.build("tmp_"+new Date().getTime(),"","",0,new Date().getTime(),1)}c.beginTransaction();var a=c.addTask(d,e);if(a){a.rowElement.click();a.rowElement.find("[name=name]").focus()}c.endTransaction()};GanttMaster.prototype.deleteCurrentTask=function(){var a=this;if(!a.currentTask||!a.canWrite||!a.currentTask.canWrite){return}var c=a.currentTask.getRow();if(a.currentTask&&(c>0||a.currentTask.isNew())){var b=a.currentTask.getParent();a.beginTransaction();a.currentTask.deleteTask();a.currentTask=undefined;a.updateDependsStrings();a.redraw();if(b){a.editor.refreshExpandStatus(b)}c=c>a.tasks.length-1?a.tasks.length-1:c;if(c>=0){a.currentTask=a.tasks[c];a.currentTask.rowElement.click();a.currentTask.rowElement.find("[name=name]").focus()}a.endTransaction()}};GanttMaster.prototype.beginTransaction=function(){if(!this.__currentTransaction){this.__currentTransaction={snapshot:JSON.stringify(this.saveGantt(true)),errors:[]}}else{console.error("Cannot open twice a transaction")}return this.__currentTransaction};GanttMaster.prototype.endTransaction=function(){if(!this.__currentTransaction){console.error("Transaction never started.");return true}var b=true;if(this.__currentTransaction.errors.length<=0){this.__undoStack.push(this.__currentTransaction.snapshot);this.__redoStack=[];this.gantt.originalStartMillis=Infinity;this.gantt.originalEndMillis=-Infinity;for(var c=0;c<this.tasks.length;c++){var a=this.tasks[c];if(this.gantt.originalStartMillis>a.start){this.gantt.originalStartMillis=a.start}if(this.gantt.originalEndMillis<a.end){this.gantt.originalEndMillis=a.end}}this.taskIsChanged()}else{b=false;var e=JSON.parse(this.__currentTransaction.snapshot);this.deletedTaskIds=e.deletedTaskIds;this.loadTasks(e.tasks,e.selectedRow);this.redraw();var f="";for(var c=0;c<this.__currentTransaction.errors.length;c++){var d=this.__currentTransaction.errors[c];f=f+d.msg+"\n\n"}alert(f)}this.__currentTransaction=undefined;this.editor.refreshExpandStatus(this.currentTask);return b};GanttMaster.prototype.setErrorOnTransaction=function(b,a){if(this.__currentTransaction){this.__currentTransaction.errors.push({msg:b,task:a})}else{console.error(b)}};GanttMaster.prototype.checkpoint=function(){this.__undoStack=[];this.__redoStack=[]};GanttMaster.prototype.undo=function(){if(this.__undoStack.length>0){var b=this.__undoStack.pop();this.__redoStack.push(JSON.stringify(this.saveGantt()));var a=JSON.parse(b);this.deletedTaskIds=a.deletedTaskIds;this.__inUndoRedo=true;this.loadTasks(a.tasks,a.selectedRow);this.redraw()}};GanttMaster.prototype.redo=function(){if(this.__redoStack.length>0){var b=this.__redoStack.pop();this.__undoStack.push(JSON.stringify(this.saveGantt()));var a=JSON.parse(b);this.deletedTaskIds=a.deletedTaskIds;this.__inUndoRedo=true;this.loadTasks(a.tasks,a.selectedRow);this.redraw()}};GanttMaster.prototype.resize=function(){this.splitter.resize()};GanttMaster.prototype.getCollapsedDescendant=function(){var c=this.tasks;var a=[];for(var d=0;d<c.length;d++){var b=c[d];if(a.indexOf(b)>=0){continue}if(b.collapsed){a=a.concat(b.getDescendant())}}return a};GanttMaster.prototype.computeCriticalPath=function(){if(!this.tasks){return false}var h=this.tasks.filter(function(i){return !i.isParent()});for(var l=0;l<h.length;l++){var s=h[l];s.earlyStart=-1;s.earlyFinish=-1;s.latestStart=-1;s.latestFinish=-1;s.criticalCost=-1;s.isCritical=false}var k=[];var f=h.concat();while(f.length>0){var a=false;for(var l=0;l<f.length;l++){var d=f[l];var m=d.getInferiorTasks();if(p(k,m)){var q=0;for(var g=0;g<m.length;g++){var s=m[g];if(s.criticalCost>q){q=s.criticalCost}}d.criticalCost=q+d.duration;k.push(d);f.splice(l,1);a=true}}if(!a){console.error("Cyclic dependency, algorithm stopped!");return false}}o(h);var c=b(h);r(c);n(h);return h;function p(u,j){for(var t=0;t<j.length;t++){if(u.indexOf(j[t])<0){return false}}return true}function o(w){var j=-1;for(var v=0;v<w.length;v++){var u=w[v];if(u.criticalCost>j){j=u.criticalCost}}for(var v=0;v<w.length;v++){var u=w[v];u.setLatest(j)}}function b(u){var t=[];for(var j=0;j<u.length;j++){if(!u[j].depends||u[j].depends==""){t.push(u[j])}}return t}function r(u){for(var t=0;t<u.length;t++){var j=u[t];j.earlyStart=0;j.earlyFinish=j.duration;e(j)}}function e(j){var w=j.earlyFinish;var x=j.getInferiorTasks();for(var v=0;v<x.length;v++){var u=x[v];if(w>=u.earlyStart){u.earlyStart=w;u.earlyFinish=w+u.duration}e(u)}}function n(v){for(var u=0;u<v.length;u++){var j=v[u];j.isCritical=(j.earlyStart==j.latestStart)}}};