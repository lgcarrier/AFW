(function(a){if(typeof define==="function"&&define.amd){define("jstree.search",["jquery","jstree"],a)}else{if(typeof exports==="object"){a(require("jquery"),require("jstree"))}else{a(jQuery,jQuery.jstree)}}}(function(b,a,c){if(b.jstree.plugins.search){return}b.jstree.defaults.search={ajax:false,fuzzy:false,case_sensitive:false,show_only_matches:false,close_opened_onclear:true,search_leaves_only:false,search_callback:false};b.jstree.plugins.search=function(d,e){this.bind=function(){e.bind.call(this);this._data.search.str="";this._data.search.dom=b();this._data.search.res=[];this._data.search.opn=[];this._data.search.som=false;this.element.on("before_open.jstree",b.proxy(function(p,n){var h,g,m,l=this._data.search.res,k=[],q=b();if(l&&l.length){this._data.search.dom=b(this.element[0].querySelectorAll("#"+b.map(l,function(f){return"0123456789".indexOf(f[0])!==-1?"\\3"+f[0]+" "+f.substr(1).replace(b.jstree.idregex,"\\$&"):f.replace(b.jstree.idregex,"\\$&")}).join(", #")));this._data.search.dom.children(".jstree-anchor").addClass("jstree-search");if(this._data.search.som&&this._data.search.res.length){for(h=0,g=l.length;h<g;h++){k=k.concat(this.get_node(l[h]).parents)}k=b.vakata.array_remove_item(b.vakata.array_unique(k),"#");q=k.length?b(this.element[0].querySelectorAll("#"+b.map(k,function(f){return"0123456789".indexOf(f[0])!==-1?"\\3"+f[0]+" "+f.substr(1).replace(b.jstree.idregex,"\\$&"):f.replace(b.jstree.idregex,"\\$&")}).join(", #"))):b();this.element.find(".jstree-node").hide().filter(".jstree-last").filter(function(){return this.nextSibling}).removeClass("jstree-last");q=q.add(this._data.search.dom);q.parentsUntil(".jstree").addBack().show().filter(".jstree-children").each(function(){b(this).children(".jstree-node:visible").eq(-1).addClass("jstree-last")})}}},this)).on("search.jstree",b.proxy(function(g,f){if(this._data.search.som){if(f.nodes.length){this.element.find(".jstree-node").hide().filter(".jstree-last").filter(function(){return this.nextSibling}).removeClass("jstree-last");f.nodes.parentsUntil(".jstree").addBack().show().filter(".jstree-children").each(function(){b(this).children(".jstree-node:visible").eq(-1).addClass("jstree-last")})}}},this)).on("clear_search.jstree",b.proxy(function(g,f){if(this._data.search.som&&f.nodes.length){this.element.find(".jstree-node").css("display","").filter(".jstree-last").filter(function(){return this.nextSibling}).removeClass("jstree-last")}},this))};this.search=function(v,x,l,o,k){if(v===false||b.trim(v.toString())===""){return this.clear_search()}o=this.get_node(o);o=o&&o.id?o.id:null;v=v.toString();var y=this.settings.search,w=y.ajax?y.ajax:false,n=this._model.data,u=null,g=[],h=[],t,q;if(this._data.search.res.length&&!k){this.clear_search()}if(l===c){l=y.show_only_matches}if(!x&&w!==false){if(b.isFunction(w)){return w.call(this,v,b.proxy(function(f){if(f&&f.d){f=f.d}this._load_nodes(!b.isArray(f)?[]:b.vakata.array_unique(f),function(){this.search(v,true,l,o,k)},true)},this),o)}else{w=b.extend({},w);if(!w.data){w.data={}}w.data.str=v;if(o){w.data.inside=o}return b.ajax(w).fail(b.proxy(function(){this._data.core.last_error={error:"ajax",plugin:"search",id:"search_01",reason:"Could not load search parents",data:JSON.stringify(w)};this.settings.core.error.call(this,this._data.core.last_error)},this)).done(b.proxy(function(f){if(f&&f.d){f=f.d}this._load_nodes(!b.isArray(f)?[]:b.vakata.array_unique(f),function(){this.search(v,true,l,o,k)},true)},this))}}if(!k){this._data.search.str=v;this._data.search.dom=b();this._data.search.res=[];this._data.search.opn=[];this._data.search.som=l}u=new b.vakata.search(v,true,{caseSensitive:y.case_sensitive,fuzzy:y.fuzzy});b.each(n[o?o:"#"].children_d,function(m,j){var f=n[j];if(f.text&&((y.search_callback&&y.search_callback.call(this,v,f))||(!y.search_callback&&u.search(f.text).isMatch))&&(!y.search_leaves_only||(f.state.loaded&&f.children.length===0))){g.push(j);h=h.concat(f.parents)}});if(g.length){h=b.vakata.array_unique(h);this._search_open(h);if(!k){this._data.search.dom=b(this.element[0].querySelectorAll("#"+b.map(g,function(f){return"0123456789".indexOf(f[0])!==-1?"\\3"+f[0]+" "+f.substr(1).replace(b.jstree.idregex,"\\$&"):f.replace(b.jstree.idregex,"\\$&")}).join(", #")));this._data.search.res=g}else{this._data.search.dom=this._data.search.dom.add(b(this.element[0].querySelectorAll("#"+b.map(g,function(f){return"0123456789".indexOf(f[0])!==-1?"\\3"+f[0]+" "+f.substr(1).replace(b.jstree.idregex,"\\$&"):f.replace(b.jstree.idregex,"\\$&")}).join(", #"))));this._data.search.res=b.vakata.array_unique(this._data.search.res.concat(g))}this._data.search.dom.children(".jstree-anchor").addClass("jstree-search")}this.trigger("search",{nodes:this._data.search.dom,str:v,res:this._data.search.res,show_only_matches:l})};this.clear_search=function(){this._data.search.dom.children(".jstree-anchor").removeClass("jstree-search");if(this.settings.search.close_opened_onclear){this.close_node(this._data.search.opn,0)}this.trigger("clear_search",{nodes:this._data.search.dom,str:this._data.search.str,res:this._data.search.res});this._data.search.str="";this._data.search.res=[];this._data.search.opn=[];this._data.search.dom=b()};this._search_open=function(g){var f=this;b.each(g.concat([]),function(j,h){if(h==="#"){return true}try{h=b("#"+h.replace(b.jstree.idregex,"\\$&"),f.element)}catch(k){}if(h&&h.length){if(f.is_closed(h)){f._data.search.opn.push(h[0].id);f.open_node(h,function(){f._search_open(g)},0)}}})}};(function(d){d.vakata.search=function(j,h,o){o=o||{};o=d.extend({},d.vakata.search.defaults,o);if(o.fuzzy!==false){o.fuzzy=true}j=o.caseSensitive?j:j.toLowerCase();var l=o.location,m=o.distance,k=o.threshold,e=j.length,f,g,i,n;if(e>32){o.fuzzy=false}if(o.fuzzy){f=1<<(e-1);g=(function(){var p={},q=0;for(q=0;q<e;q++){p[j.charAt(q)]=0}for(q=0;q<e;q++){p[j.charAt(q)]|=1<<(e-q-1)}return p}());i=function(s,p){var r=s/e,q=Math.abs(l-p);if(!m){return q?1:r}return r+(q/m)}}n=function(C){C=o.caseSensitive?C:C.toLowerCase();if(j===C||C.indexOf(j)!==-1){return{isMatch:true,score:0}}if(!o.fuzzy){return{isMatch:false,score:1}}var x,w,B=C.length,t=k,v=C.indexOf(j,l),z,s,q=e+B,p,r,A,E,D,u=1,y=[];if(v!==-1){t=Math.min(i(0,v),t);v=C.lastIndexOf(j,l+e);if(v!==-1){t=Math.min(i(0,v),t)}}v=-1;for(x=0;x<e;x++){z=0;s=q;while(z<s){if(i(x,l+s)<=t){z=s}else{q=s}s=Math.floor((q-z)/2+z)}q=s;r=Math.max(1,l-s+1);A=Math.min(l+s,B)+e;E=new Array(A+2);E[A+1]=(1<<x)-1;for(w=A;w>=r;w--){D=g[C.charAt(w-1)];if(x===0){E[w]=((E[w+1]<<1)|1)&D}else{E[w]=((E[w+1]<<1)|1)&D|(((p[w+1]|p[w])<<1)|1)|p[w+1]}if(E[w]&f){u=i(x,w-1);if(u<=t){t=u;v=w-1;y.push(v);if(v>l){r=Math.max(1,2*l-v)}else{break}}}}if(i(x+1,l)>t){break}p=E}return{isMatch:v>=0,score:u}};return h===true?{search:n}:n(h)};d.vakata.search.defaults={location:0,distance:100,threshold:0.6,fuzzy:false,caseSensitive:false}}(b))}));