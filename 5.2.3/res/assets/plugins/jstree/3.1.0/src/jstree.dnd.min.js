(function(a){if(typeof define==="function"&&define.amd){define("jstree.dnd",["jquery","jstree"],a)}else{if(typeof exports==="object"){a(require("jquery"),require("jstree"))}else{a(jQuery,jQuery.jstree)}}}(function(b,a,c){if(b.jstree.plugins.dnd){return}b.jstree.defaults.dnd={copy:true,open_timeout:500,is_draggable:true,check_while_dragging:true,always_copy:false,inside_pos:0,drag_selection:true,touch:true,large_drop_target:false,large_drag_target:false};b.jstree.plugins.dnd=function(d,e){this.bind=function(){e.bind.call(this);this.element.on("mousedown.jstree touchstart.jstree",this.settings.dnd.large_drag_target?".jstree-node":".jstree-anchor",b.proxy(function(i){if(this.settings.dnd.large_drag_target&&b(i.target).closest(".jstree-node")[0]!==i.currentTarget){return true}if(i.type==="touchstart"&&(!this.settings.dnd.touch||(this.settings.dnd.touch==="selected"&&!b(i.currentTarget).closest(".jstree-node").children(".jstree-anchor").hasClass("jstree-clicked")))){return true}var h=this.get_node(i.target),g=this.is_selected(h)&&this.settings.dnd.drag_selection?this.get_top_selected().length:1,f=(g>1?g+" "+this.get_string("nodes"):this.get_text(i.currentTarget));if(this.settings.core.force_text){f=b.vakata.html.escape(f)}if(h&&h.id&&h.id!=="#"&&(i.which===1||i.type==="touchstart")&&(this.settings.dnd.is_draggable===true||(b.isFunction(this.settings.dnd.is_draggable)&&this.settings.dnd.is_draggable.call(this,(g>1?this.get_top_selected(true):[h]))))){this.element.trigger("mousedown.jstree");return b.vakata.dnd.start(i,{jstree:true,origin:this,obj:this.get_node(h,true),nodes:g>1?this.get_top_selected():[h.id]},'<div id="jstree-dnd" class="jstree-'+this.get_theme()+" jstree-"+this.get_theme()+"-"+this.get_theme_variant()+" "+(this.settings.core.themes.responsive?" jstree-dnd-responsive":"")+'"><i class="jstree-icon jstree-er"></i>'+f+'<ins class="jstree-copy" style="display:none;">+</ins></div>')}},this))}};b(function(){var g=false,f=false,e=false,d=b('<div id="jstree-marker">&#160;</div>').hide();b(document).on("dnd_start.vakata.jstree",function(i,h){g=false;if(!h||!h.data||!h.data.jstree){return}d.appendTo("body")}).on("dnd_move.vakata.jstree",function(E,H){if(e){clearTimeout(e)}if(!H||!H.data||!H.data.jstree){return}if(H.event.target.id&&H.event.target.id==="jstree-marker"){return}var j=b.jstree.reference(H.event.target),n=false,G=false,k=false,F,B,w,D,x,C,y,v,u,s,r,z,A,q,m;if(j&&j._data&&j._data.dnd){d.attr("class","jstree-"+j.get_theme()+(j.settings.core.themes.responsive?" jstree-dnd-responsive":""));H.helper.children().attr("class","jstree-"+j.get_theme()+" jstree-"+j.get_theme()+"-"+j.get_theme_variant()+" "+(j.settings.core.themes.responsive?" jstree-dnd-responsive":"")).find(".jstree-copy").first()[H.data.origin&&(H.data.origin.settings.dnd.always_copy||(H.data.origin.settings.dnd.copy&&(H.event.metaKey||H.event.ctrlKey)))?"show":"hide"]();if((H.event.target===j.element[0]||H.event.target===j.get_container_ul()[0])&&j.get_container_ul().children().length===0){v=true;for(u=0,s=H.data.nodes.length;u<s;u++){v=v&&j.check((H.data.origin&&(H.data.origin.settings.dnd.always_copy||(H.data.origin.settings.dnd.copy&&(H.event.metaKey||H.event.ctrlKey)))?"copy_node":"move_node"),(H.data.origin&&H.data.origin!==j?H.data.origin.get_node(H.data.nodes[u]):H.data.nodes[u]),"#","last",{dnd:true,ref:j.get_node("#"),pos:"i",origin:H.data.origin,is_multi:(H.data.origin&&H.data.origin!==j),is_foreign:(!H.data.origin)});if(!v){break}}if(v){g={ins:j,par:"#",pos:"last"};d.hide();H.helper.find(".jstree-icon").first().removeClass("jstree-er").addClass("jstree-ok");return}}else{n=j.settings.dnd.large_drop_target?b(H.event.target).closest(".jstree-node").children(".jstree-anchor"):b(H.event.target).closest(".jstree-anchor");if(n&&n.length&&n.parent().is(".jstree-closed, .jstree-open, .jstree-leaf")){G=n.offset();k=H.event.pageY-G.top;D=n.outerHeight();if(k<D/3){y=["b","i","a"]}else{if(k>D-D/3){y=["a","i","b"]}else{y=k>D/2?["i","a","b"]:["i","b","a"]}}b.each(y,function(i,h){switch(h){case"b":B=G.left-6;w=G.top;x=j.get_parent(n);C=n.parent().index();break;case"i":q=j.settings.dnd.inside_pos;m=j.get_node(n.parent());B=G.left-2;w=G.top+D/2+1;x=m.id;C=q==="first"?0:(q==="last"?m.children.length:Math.min(q,m.children.length));break;case"a":B=G.left-6;w=G.top+D;x=j.get_parent(n);C=n.parent().index()+1;break}v=true;for(u=0,s=H.data.nodes.length;u<s;u++){r=H.data.origin&&(H.data.origin.settings.dnd.always_copy||(H.data.origin.settings.dnd.copy&&(H.event.metaKey||H.event.ctrlKey)))?"copy_node":"move_node";z=C;if(r==="move_node"&&h==="a"&&(H.data.origin&&H.data.origin===j)&&x===j.get_parent(H.data.nodes[u])){A=j.get_node(x);if(z>b.inArray(H.data.nodes[u],A.children)){z-=1}}v=v&&((j&&j.settings&&j.settings.dnd&&j.settings.dnd.check_while_dragging===false)||j.check(r,(H.data.origin&&H.data.origin!==j?H.data.origin.get_node(H.data.nodes[u]):H.data.nodes[u]),x,z,{dnd:true,ref:j.get_node(n.parent()),pos:h,origin:H.data.origin,is_multi:(H.data.origin&&H.data.origin!==j),is_foreign:(!H.data.origin)}));if(!v){if(j&&j.last_error){f=j.last_error()}break}}if(h==="i"&&n.parent().is(".jstree-closed")&&j.settings.dnd.open_timeout){e=setTimeout((function(l,o){return function(){l.open_node(o)}}(j,n)),j.settings.dnd.open_timeout)}if(v){g={ins:j,par:x,pos:h==="i"&&q==="last"&&C===0&&!j.is_loaded(m)?"last":C};d.css({left:B+"px",top:w+"px"}).show();H.helper.find(".jstree-icon").first().removeClass("jstree-er").addClass("jstree-ok");f={};y=true;return false}});if(y===true){return}}}}g=false;H.helper.find(".jstree-icon").removeClass("jstree-ok").addClass("jstree-er");d.hide()}).on("dnd_scroll.vakata.jstree",function(i,h){if(!h||!h.data||!h.data.jstree){return}d.hide();g=false;h.helper.find(".jstree-icon").first().removeClass("jstree-ok").addClass("jstree-er")}).on("dnd_stop.vakata.jstree",function(n,m){if(e){clearTimeout(e)}if(!m||!m.data||!m.data.jstree){return}d.hide().detach();var l,k,h=[];if(g){for(l=0,k=m.data.nodes.length;l<k;l++){h[l]=m.data.origin?m.data.origin.get_node(m.data.nodes[l]):m.data.nodes[l]}g.ins[m.data.origin&&(m.data.origin.settings.dnd.always_copy||(m.data.origin.settings.dnd.copy&&(m.event.metaKey||m.event.ctrlKey)))?"copy_node":"move_node"](h,g.par,g.pos,false,false,false,m.data.origin)}else{l=b(m.event.target).closest(".jstree");if(l.length&&f&&f.error&&f.error==="check"){l=l.jstree(true);if(l){l.settings.core.error.call(this,f)}}}}).on("keyup.jstree keydown.jstree",function(i,h){h=b.vakata.dnd._get();if(h&&h.data&&h.data.jstree){h.helper.find(".jstree-copy").first()[h.data.origin&&(h.data.origin.settings.dnd.always_copy||(h.data.origin.settings.dnd.copy&&(i.metaKey||i.ctrlKey)))?"show":"hide"]()}})});(function(e){e.vakata.html={div:e("<div />"),escape:function(f){return e.vakata.html.div.text(f).html()},strip:function(f){return e.vakata.html.div.empty().append(e.parseHTML(f)).text()}};var d={element:false,target:false,is_down:false,is_drag:false,helper:false,helper_w:0,data:false,init_x:0,init_y:0,scroll_l:0,scroll_t:0,scroll_e:false,scroll_i:false,is_touch:false};e.vakata.dnd={settings:{scroll_speed:10,scroll_proximity:20,helper_left:5,helper_top:10,threshold:5,threshold_touch:50},_trigger:function(h,g){var f=e.vakata.dnd._get();f.event=g;e(document).triggerHandler("dnd_"+h+".vakata",f)},_get:function(){return{data:d.data,element:d.element,helper:d.helper}},_clean:function(){if(d.helper){d.helper.remove()}if(d.scroll_i){clearInterval(d.scroll_i);d.scroll_i=false}d={element:false,target:false,is_down:false,is_drag:false,helper:false,helper_w:0,data:false,init_x:0,init_y:0,scroll_l:0,scroll_t:0,scroll_e:false,scroll_i:false,is_touch:false};e(document).off("mousemove.vakata.jstree touchmove.vakata.jstree",e.vakata.dnd.drag);e(document).off("mouseup.vakata.jstree touchend.vakata.jstree",e.vakata.dnd.stop)},_scroll:function(h){if(!d.scroll_e||(!d.scroll_l&&!d.scroll_t)){if(d.scroll_i){clearInterval(d.scroll_i);d.scroll_i=false}return false}if(!d.scroll_i){d.scroll_i=setInterval(e.vakata.dnd._scroll,100);return false}if(h===true){return false}var g=d.scroll_e.scrollTop(),f=d.scroll_e.scrollLeft();d.scroll_e.scrollTop(g+d.scroll_t*e.vakata.dnd.settings.scroll_speed);d.scroll_e.scrollLeft(f+d.scroll_l*e.vakata.dnd.settings.scroll_speed);if(g!==d.scroll_e.scrollTop()||f!==d.scroll_e.scrollLeft()){e.vakata.dnd._trigger("scroll",d.scroll_e)}},start:function(h,g,f){if(h.type==="touchstart"&&h.originalEvent&&h.originalEvent.changedTouches&&h.originalEvent.changedTouches[0]){h.pageX=h.originalEvent.changedTouches[0].pageX;h.pageY=h.originalEvent.changedTouches[0].pageY;h.target=document.elementFromPoint(h.originalEvent.changedTouches[0].pageX-window.pageXOffset,h.originalEvent.changedTouches[0].pageY-window.pageYOffset)}if(d.is_drag){e.vakata.dnd.stop({})}try{h.currentTarget.unselectable="on";h.currentTarget.onselectstart=function(){return false};if(h.currentTarget.style){h.currentTarget.style.MozUserSelect="none"}}catch(i){}d.init_x=h.pageX;d.init_y=h.pageY;d.data=g;d.is_down=true;d.element=h.currentTarget;d.target=h.target;d.is_touch=h.type==="touchstart";if(f!==false){d.helper=e("<div id='vakata-dnd'></div>").html(f).css({display:"block",margin:"0",padding:"0",position:"absolute",top:"-2000px",lineHeight:"16px",zIndex:"10000"})}e(document).on("mousemove.vakata.jstree touchmove.vakata.jstree",e.vakata.dnd.drag);e(document).on("mouseup.vakata.jstree touchend.vakata.jstree",e.vakata.dnd.stop);return false},drag:function(l){if(l.type==="touchmove"&&l.originalEvent&&l.originalEvent.changedTouches&&l.originalEvent.changedTouches[0]){l.pageX=l.originalEvent.changedTouches[0].pageX;l.pageY=l.originalEvent.changedTouches[0].pageY;l.target=document.elementFromPoint(l.originalEvent.changedTouches[0].pageX-window.pageXOffset,l.originalEvent.changedTouches[0].pageY-window.pageYOffset)}if(!d.is_down){return}if(!d.is_drag){if(Math.abs(l.pageX-d.init_x)>(d.is_touch?e.vakata.dnd.settings.threshold_touch:e.vakata.dnd.settings.threshold)||Math.abs(l.pageY-d.init_y)>(d.is_touch?e.vakata.dnd.settings.threshold_touch:e.vakata.dnd.settings.threshold)){if(d.helper){d.helper.appendTo("body");d.helper_w=d.helper.outerWidth()}d.is_drag=true;e.vakata.dnd._trigger("start",l)}else{return}}var m=false,p=false,n=false,g=false,f=false,j=false,i=false,k=false,o=false,h=false;d.scroll_t=0;d.scroll_l=0;d.scroll_e=false;e(e(l.target).parentsUntil("body").addBack().get().reverse()).filter(function(){return(/^auto|scroll$/).test(e(this).css("overflow"))&&(this.scrollHeight>this.offsetHeight||this.scrollWidth>this.offsetWidth)}).each(function(){var q=e(this),r=q.offset();if(this.scrollHeight>this.offsetHeight){if(r.top+q.height()-l.pageY<e.vakata.dnd.settings.scroll_proximity){d.scroll_t=1}if(l.pageY-r.top<e.vakata.dnd.settings.scroll_proximity){d.scroll_t=-1}}if(this.scrollWidth>this.offsetWidth){if(r.left+q.width()-l.pageX<e.vakata.dnd.settings.scroll_proximity){d.scroll_l=1}if(l.pageX-r.left<e.vakata.dnd.settings.scroll_proximity){d.scroll_l=-1}}if(d.scroll_t||d.scroll_l){d.scroll_e=e(this);return false}});if(!d.scroll_e){m=e(document);p=e(window);n=m.height();g=p.height();f=m.width();j=p.width();i=m.scrollTop();k=m.scrollLeft();if(n>g&&l.pageY-i<e.vakata.dnd.settings.scroll_proximity){d.scroll_t=-1}if(n>g&&g-(l.pageY-i)<e.vakata.dnd.settings.scroll_proximity){d.scroll_t=1}if(f>j&&l.pageX-k<e.vakata.dnd.settings.scroll_proximity){d.scroll_l=-1}if(f>j&&j-(l.pageX-k)<e.vakata.dnd.settings.scroll_proximity){d.scroll_l=1}if(d.scroll_t||d.scroll_l){d.scroll_e=m}}if(d.scroll_e){e.vakata.dnd._scroll(true)}if(d.helper){o=parseInt(l.pageY+e.vakata.dnd.settings.helper_top,10);h=parseInt(l.pageX+e.vakata.dnd.settings.helper_left,10);if(n&&o+25>n){o=n-50}if(f&&h+d.helper_w>f){h=f-(d.helper_w+2)}d.helper.css({left:h+"px",top:o+"px"})}e.vakata.dnd._trigger("move",l);return false},stop:function(f){if(f.type==="touchend"&&f.originalEvent&&f.originalEvent.changedTouches&&f.originalEvent.changedTouches[0]){f.pageX=f.originalEvent.changedTouches[0].pageX;f.pageY=f.originalEvent.changedTouches[0].pageY;f.target=document.elementFromPoint(f.originalEvent.changedTouches[0].pageX-window.pageXOffset,f.originalEvent.changedTouches[0].pageY-window.pageYOffset)}if(d.is_drag){e.vakata.dnd._trigger("stop",f)}else{if(f.type==="touchend"&&f.target===d.target){var g=setTimeout(function(){e(f.target).click()},100);e(f.target).one("click",function(){if(g){clearTimeout(g)}})}}e.vakata.dnd._clean();return false}}}(b))}));