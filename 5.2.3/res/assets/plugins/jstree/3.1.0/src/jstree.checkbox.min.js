(function(a){if(typeof define==="function"&&define.amd){define("jstree.checkbox",["jquery","jstree"],a)}else{if(typeof exports==="object"){a(require("jquery"),require("jstree"))}else{a(jQuery,jQuery.jstree)}}}(function(c,a,d){if(c.jstree.plugins.checkbox){return}var b=document.createElement("I");b.className="jstree-icon jstree-checkbox";b.setAttribute("role","presentation");c.jstree.defaults.checkbox={visible:true,three_state:true,whole_node:true,keep_selected_style:true,cascade:"",tie_selection:true};c.jstree.plugins.checkbox=function(e,f){this.bind=function(){f.bind.call(this);this._data.checkbox.uto=false;this._data.checkbox.selected=[];if(this.settings.checkbox.three_state){this.settings.checkbox.cascade="up+down+undetermined"}this.element.on("init.jstree",c.proxy(function(){this._data.checkbox.visible=this.settings.checkbox.visible;if(!this.settings.checkbox.keep_selected_style){this.element.addClass("jstree-checkbox-no-clicked")}if(this.settings.checkbox.tie_selection){this.element.addClass("jstree-checkbox-selection")}},this)).on("loading.jstree",c.proxy(function(){this[this._data.checkbox.visible?"show_checkboxes":"hide_checkboxes"]()},this));if(this.settings.checkbox.cascade.indexOf("undetermined")!==-1){this.element.on("changed.jstree uncheck_node.jstree check_node.jstree uncheck_all.jstree check_all.jstree move_node.jstree copy_node.jstree redraw.jstree open_node.jstree",c.proxy(function(){if(this._data.checkbox.uto){clearTimeout(this._data.checkbox.uto)}this._data.checkbox.uto=setTimeout(c.proxy(this._undetermined,this),50)},this))}if(!this.settings.checkbox.tie_selection){this.element.on("model.jstree",c.proxy(function(o,l){var g=this._model.data,n=g[l.parent],q=l.nodes,k,h;for(k=0,h=q.length;k<h;k++){g[q[k]].state.checked=(g[q[k]].original&&g[q[k]].original.state&&g[q[k]].original.state.checked);if(g[q[k]].state.checked){this._data.checkbox.selected.push(q[k])}}},this))}if(this.settings.checkbox.cascade.indexOf("up")!==-1||this.settings.checkbox.cascade.indexOf("down")!==-1){this.element.on("model.jstree",c.proxy(function(x,u){var h=this._model.data,g=h[u.parent],w=u.nodes,B=[],y,v,q,o,n,r,A=this.settings.checkbox.cascade,z=this.settings.checkbox.tie_selection;if(A.indexOf("down")!==-1){if(g.state[z?"selected":"checked"]){for(v=0,q=w.length;v<q;v++){h[w[v]].state[z?"selected":"checked"]=true}this._data[z?"core":"checkbox"].selected=this._data[z?"core":"checkbox"].selected.concat(w)}else{for(v=0,q=w.length;v<q;v++){if(h[w[v]].state[z?"selected":"checked"]){for(o=0,n=h[w[v]].children_d.length;o<n;o++){h[h[w[v]].children_d[o]].state[z?"selected":"checked"]=true}this._data[z?"core":"checkbox"].selected=this._data[z?"core":"checkbox"].selected.concat(h[w[v]].children_d)}}}}if(A.indexOf("up")!==-1){for(v=0,q=g.children_d.length;v<q;v++){if(!h[g.children_d[v]].children.length){B.push(h[g.children_d[v]].parent)}}B=c.vakata.array_unique(B);for(o=0,n=B.length;o<n;o++){g=h[B[o]];while(g&&g.id!=="#"){y=0;for(v=0,q=g.children.length;v<q;v++){y+=h[g.children[v]].state[z?"selected":"checked"]}if(y===q){g.state[z?"selected":"checked"]=true;this._data[z?"core":"checkbox"].selected.push(g.id);r=this.get_node(g,true);if(r&&r.length){r.attr("aria-selected",true).children(".jstree-anchor").addClass(z?"jstree-clicked":"jstree-checked")}}else{break}g=this.get_node(g.parent)}}}this._data[z?"core":"checkbox"].selected=c.vakata.array_unique(this._data[z?"core":"checkbox"].selected)},this)).on(this.settings.checkbox.tie_selection?"select_node.jstree":"check_node.jstree",c.proxy(function(q,o){var n=o.node,g=this._model.data,r=this.get_node(n.parent),h=this.get_node(n,true),p,k,u,l,w=this.settings.checkbox.cascade,v=this.settings.checkbox.tie_selection;if(w.indexOf("down")!==-1){this._data[v?"core":"checkbox"].selected=c.vakata.array_unique(this._data[v?"core":"checkbox"].selected.concat(n.children_d));for(p=0,k=n.children_d.length;p<k;p++){l=g[n.children_d[p]];l.state[v?"selected":"checked"]=true;if(l&&l.original&&l.original.state&&l.original.state.undetermined){l.original.state.undetermined=false}}}if(w.indexOf("up")!==-1){while(r&&r.id!=="#"){u=0;for(p=0,k=r.children.length;p<k;p++){u+=g[r.children[p]].state[v?"selected":"checked"]}if(u===k){r.state[v?"selected":"checked"]=true;this._data[v?"core":"checkbox"].selected.push(r.id);l=this.get_node(r,true);if(l&&l.length){l.attr("aria-selected",true).children(".jstree-anchor").addClass(v?"jstree-clicked":"jstree-checked")}}else{break}r=this.get_node(r.parent)}}if(w.indexOf("down")!==-1&&h.length){h.find(".jstree-anchor").addClass(v?"jstree-clicked":"jstree-checked").parent().attr("aria-selected",true)}},this)).on(this.settings.checkbox.tie_selection?"deselect_all.jstree":"uncheck_all.jstree",c.proxy(function(p,n){var o=this.get_node("#"),g=this._model.data,l,h,k;for(l=0,h=o.children_d.length;l<h;l++){k=g[o.children_d[l]];if(k&&k.original&&k.original.state&&k.original.state.undetermined){k.original.state.undetermined=false}}},this)).on(this.settings.checkbox.tie_selection?"deselect_node.jstree":"uncheck_node.jstree",c.proxy(function(o,l){var k=l.node,g=this.get_node(k,true),m,h,n,q=this.settings.checkbox.cascade,p=this.settings.checkbox.tie_selection;if(k&&k.original&&k.original.state&&k.original.state.undetermined){k.original.state.undetermined=false}if(q.indexOf("down")!==-1){for(m=0,h=k.children_d.length;m<h;m++){n=this._model.data[k.children_d[m]];n.state[p?"selected":"checked"]=false;if(n&&n.original&&n.original.state&&n.original.state.undetermined){n.original.state.undetermined=false}}}if(q.indexOf("up")!==-1){for(m=0,h=k.parents.length;m<h;m++){n=this._model.data[k.parents[m]];n.state[p?"selected":"checked"]=false;if(n&&n.original&&n.original.state&&n.original.state.undetermined){n.original.state.undetermined=false}n=this.get_node(k.parents[m],true);if(n&&n.length){n.attr("aria-selected",false).children(".jstree-anchor").removeClass(p?"jstree-clicked":"jstree-checked")}}}n=[];for(m=0,h=this._data[p?"core":"checkbox"].selected.length;m<h;m++){if((q.indexOf("down")===-1||c.inArray(this._data[p?"core":"checkbox"].selected[m],k.children_d)===-1)&&(q.indexOf("up")===-1||c.inArray(this._data[p?"core":"checkbox"].selected[m],k.parents)===-1)){n.push(this._data[p?"core":"checkbox"].selected[m])}}this._data[p?"core":"checkbox"].selected=c.vakata.array_unique(n);if(q.indexOf("down")!==-1&&g.length){g.find(".jstree-anchor").removeClass(p?"jstree-clicked":"jstree-checked").parent().attr("aria-selected",false)}},this))}if(this.settings.checkbox.cascade.indexOf("up")!==-1){this.element.on("delete_node.jstree",c.proxy(function(q,l){var g=this.get_node(l.parent),h=this._model.data,n,k,r,o,s=this.settings.checkbox.tie_selection;while(g&&g.id!=="#"){r=0;for(n=0,k=g.children.length;n<k;n++){r+=h[g.children[n]].state[s?"selected":"checked"]}if(r===k){g.state[s?"selected":"checked"]=true;this._data[s?"core":"checkbox"].selected.push(g.id);o=this.get_node(g,true);if(o&&o.length){o.attr("aria-selected",true).children(".jstree-anchor").addClass(s?"jstree-clicked":"jstree-checked")}}else{break}g=this.get_node(g.parent)}},this)).on("move_node.jstree",c.proxy(function(u,r){var l=r.is_multi,s=r.old_parent,g=this.get_node(r.parent),k=this._model.data,h,v,q,n,o,w=this.settings.checkbox.tie_selection;if(!l){h=this.get_node(s);while(h&&h.id!=="#"){v=0;for(q=0,n=h.children.length;q<n;q++){v+=k[h.children[q]].state[w?"selected":"checked"]}if(v===n){h.state[w?"selected":"checked"]=true;this._data[w?"core":"checkbox"].selected.push(h.id);o=this.get_node(h,true);if(o&&o.length){o.attr("aria-selected",true).children(".jstree-anchor").addClass(w?"jstree-clicked":"jstree-checked")}}else{break}h=this.get_node(h.parent)}}h=g;while(h&&h.id!=="#"){v=0;for(q=0,n=h.children.length;q<n;q++){v+=k[h.children[q]].state[w?"selected":"checked"]}if(v===n){if(!h.state[w?"selected":"checked"]){h.state[w?"selected":"checked"]=true;this._data[w?"core":"checkbox"].selected.push(h.id);o=this.get_node(h,true);if(o&&o.length){o.attr("aria-selected",true).children(".jstree-anchor").addClass(w?"jstree-clicked":"jstree-checked")}}}else{if(h.state[w?"selected":"checked"]){h.state[w?"selected":"checked"]=false;this._data[w?"core":"checkbox"].selected=c.vakata.array_remove_item(this._data[w?"core":"checkbox"].selected,h.id);o=this.get_node(h,true);if(o&&o.length){o.attr("aria-selected",false).children(".jstree-anchor").removeClass(w?"jstree-clicked":"jstree-checked")}}else{break}}h=this.get_node(h.parent)}},this))}};this._undetermined=function(){var v,u,r,q,h={},n=this._model.data,x=this.settings.checkbox.tie_selection,y=this._data[x?"core":"checkbox"].selected,g=[],w=this;for(v=0,u=y.length;v<u;v++){if(n[y[v]]&&n[y[v]].parents){for(r=0,q=n[y[v]].parents.length;r<q;r++){if(h[n[y[v]].parents[r]]===d&&n[y[v]].parents[r]!=="#"){h[n[y[v]].parents[r]]=true;g.push(n[y[v]].parents[r])}}}}this.element.find(".jstree-closed").not(":has(.jstree-children)").each(function(){var i=w.get_node(this),j;if(!i.state.loaded){if(i.original&&i.original.state&&i.original.state.undetermined&&i.original.state.undetermined===true){if(h[i.id]===d&&i.id!=="#"){h[i.id]=true;g.push(i.id)}for(r=0,q=i.parents.length;r<q;r++){if(h[i.parents[r]]===d&&i.parents[r]!=="#"){h[i.parents[r]]=true;g.push(i.parents[r])}}}}else{for(v=0,u=i.children_d.length;v<u;v++){j=n[i.children_d[v]];if(!j.state.loaded&&j.original&&j.original.state&&j.original.state.undetermined&&j.original.state.undetermined===true){if(h[j.id]===d&&j.id!=="#"){h[j.id]=true;g.push(j.id)}for(r=0,q=j.parents.length;r<q;r++){if(h[j.parents[r]]===d&&j.parents[r]!=="#"){h[j.parents[r]]=true;g.push(j.parents[r])}}}}}});this.element.find(".jstree-undetermined").removeClass("jstree-undetermined");for(v=0,u=g.length;v<u;v++){if(!n[g[v]].state[x?"selected":"checked"]){y=this.get_node(g[v],true);if(y&&y.length){y.children(".jstree-anchor").children(".jstree-checkbox").addClass("jstree-undetermined")}}}};this.redraw_node=function(o,g,m,n){o=f.redraw_node.apply(this,arguments);if(o){var l,h,k=null;for(l=0,h=o.childNodes.length;l<h;l++){if(o.childNodes[l]&&o.childNodes[l].className&&o.childNodes[l].className.indexOf("jstree-anchor")!==-1){k=o.childNodes[l];break}}if(k){if(!this.settings.checkbox.tie_selection&&this._model.data[o.id].state.checked){k.className+=" jstree-checked"}k.insertBefore(b.cloneNode(false),k.childNodes[0])}}if(!m&&this.settings.checkbox.cascade.indexOf("undetermined")!==-1){if(this._data.checkbox.uto){clearTimeout(this._data.checkbox.uto)}this._data.checkbox.uto=setTimeout(c.proxy(this._undetermined,this),50)}return o};this.show_checkboxes=function(){this._data.core.themes.checkboxes=true;this.get_container_ul().removeClass("jstree-no-checkboxes")};this.hide_checkboxes=function(){this._data.core.themes.checkboxes=false;this.get_container_ul().addClass("jstree-no-checkboxes")};this.toggle_checkboxes=function(){if(this._data.core.themes.checkboxes){this.hide_checkboxes()}else{this.show_checkboxes()}};this.is_undetermined=function(o){o=this.get_node(o);var n=this.settings.checkbox.cascade,l,h,k=this.settings.checkbox.tie_selection,p=this._data[k?"core":"checkbox"].selected,g=this._model.data;if(!o||o.state[k?"selected":"checked"]===true||n.indexOf("undetermined")===-1||(n.indexOf("down")===-1&&n.indexOf("up")===-1)){return false}if(!o.state.loaded&&o.original.state.undetermined===true){return true}for(l=0,h=o.children_d.length;l<h;l++){if(c.inArray(o.children_d[l],p)!==-1||(!g[o.children_d[l]].state.loaded&&g[o.children_d[l]].original.state.undetermined)){return true}}return false};this.activate_node=function(h,g){if(this.settings.checkbox.tie_selection&&(this.settings.checkbox.whole_node||c(g.target).hasClass("jstree-checkbox"))){g.ctrlKey=true}if(this.settings.checkbox.tie_selection||(!this.settings.checkbox.whole_node&&!c(g.target).hasClass("jstree-checkbox"))){return f.activate_node.call(this,h,g)}if(this.is_disabled(h)){return false}if(this.is_checked(h)){this.uncheck_node(h,g)}else{this.check_node(h,g)}this.trigger("activate_node",{node:this.get_node(h)})};this.check_node=function(k,j){if(this.settings.checkbox.tie_selection){return this.select_node(k,false,true,j)}var l,i,g,h;if(c.isArray(k)){k=k.slice();for(i=0,g=k.length;i<g;i++){this.check_node(k[i],j)}return true}k=this.get_node(k);if(!k||k.id==="#"){return false}l=this.get_node(k,true);if(!k.state.checked){k.state.checked=true;this._data.checkbox.selected.push(k.id);if(l&&l.length){l.children(".jstree-anchor").addClass("jstree-checked")}this.trigger("check_node",{node:k,selected:this._data.checkbox.selected,event:j})}};this.uncheck_node=function(j,i){if(this.settings.checkbox.tie_selection){return this.deselect_node(j,false,i)}var h,g,k;if(c.isArray(j)){j=j.slice();for(h=0,g=j.length;h<g;h++){this.uncheck_node(j[h],i)}return true}j=this.get_node(j);if(!j||j.id==="#"){return false}k=this.get_node(j,true);if(j.state.checked){j.state.checked=false;this._data.checkbox.selected=c.vakata.array_remove_item(this._data.checkbox.selected,j.id);if(k.length){k.children(".jstree-anchor").removeClass("jstree-checked")}this.trigger("uncheck_node",{node:j,selected:this._data.checkbox.selected,event:i})}};this.check_all=function(){if(this.settings.checkbox.tie_selection){return this.select_all()}var k=this._data.checkbox.selected.concat([]),h,g;this._data.checkbox.selected=this._model.data["#"].children_d.concat();for(h=0,g=this._data.checkbox.selected.length;h<g;h++){if(this._model.data[this._data.checkbox.selected[h]]){this._model.data[this._data.checkbox.selected[h]].state.checked=true}}this.redraw(true);this.trigger("check_all",{selected:this._data.checkbox.selected})};this.uncheck_all=function(){if(this.settings.checkbox.tie_selection){return this.deselect_all()}var k=this._data.checkbox.selected.concat([]),h,g;for(h=0,g=this._data.checkbox.selected.length;h<g;h++){if(this._model.data[this._data.checkbox.selected[h]]){this._model.data[this._data.checkbox.selected[h]].state.checked=false}}this._data.checkbox.selected=[];this.element.find(".jstree-checked").removeClass("jstree-checked");this.trigger("uncheck_all",{selected:this._data.checkbox.selected,node:k})};this.is_checked=function(g){if(this.settings.checkbox.tie_selection){return this.is_selected(g)}g=this.get_node(g);if(!g||g.id==="#"){return false}return g.state.checked};this.get_checked=function(g){if(this.settings.checkbox.tie_selection){return this.get_selected(g)}return g?c.map(this._data.checkbox.selected,c.proxy(function(h){return this.get_node(h)},this)):this._data.checkbox.selected};this.get_top_checked=function(p){if(this.settings.checkbox.tie_selection){return this.get_top_selected(p)}var o=this.get_checked(true),q={},n,m,h,g;for(n=0,m=o.length;n<m;n++){q[o[n].id]=o[n]}for(n=0,m=o.length;n<m;n++){for(h=0,g=o[n].children_d.length;h<g;h++){if(q[o[n].children_d[h]]){delete q[o[n].children_d[h]]}}}o=[];for(n in q){if(q.hasOwnProperty(n)){o.push(n)}}return p?c.map(o,c.proxy(function(j){return this.get_node(j)},this)):o};this.get_bottom_checked=function(l){if(this.settings.checkbox.tie_selection){return this.get_bottom_selected(l)}var k=this.get_checked(true),m=[],h,g;for(h=0,g=k.length;h<g;h++){if(!k[h].children.length){m.push(k[h].id)}}return l?c.map(m,c.proxy(function(j){return this.get_node(j)},this)):m};this.load_node=function(p,r){var h,g,o,m,q,n;if(!c.isArray(p)&&!this.settings.checkbox.tie_selection){n=this.get_node(p);if(n&&n.state.loaded){for(h=0,g=n.children_d.length;h<g;h++){if(this._model.data[n.children_d[h]].state.checked){q=true;this._data.checkbox.selected=c.vakata.array_remove_item(this._data.checkbox.selected,n.children_d[h])}}}}return f.load_node.apply(this,arguments)};this.get_state=function(){var g=f.get_state.apply(this,arguments);if(this.settings.checkbox.tie_selection){return g}g.checkbox=this._data.checkbox.selected.slice();return g};this.set_state=function(h,j){var g=f.set_state.apply(this,arguments);if(g&&h.checkbox){if(!this.settings.checkbox.tie_selection){this.uncheck_all();var i=this;c.each(h.checkbox,function(l,k){i.check_node(k)})}delete h.checkbox;this.set_state(h,j);return false}return g}}}));